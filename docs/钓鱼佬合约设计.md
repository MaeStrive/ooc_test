# 钓鱼佬合约设计

[TOC]

## 1 设计说明

该文档是对钓鱼佬游戏涉及的合约，进行的开发设计。设计中需要详细说明几种钓鱼佬游戏的合约有：

- 玩家状态合约
- 渔场合约
- 鱼竿NFT合约
- 钓手NFT合约
- GMC合约

合约必须说明清楚必要的合约名称、操作权限、必要的函数功能。

## 2 合约设计

### 2.1 玩家状态合约

#### 2.1.1 合约功能说明

玩家状态合约（User.sol）负责管理玩家的各种属性和状态,包括玩家注册、属性管理、钓鱼相关状态管理等功能。

#### 2.1.2 详细设计

- 合约概要

  | 合约名称     | 玩家状态合约 |
  | ------------ | ------------ |
  | 合约英文名称 | User         |

- 合约属性

  1. 玩家信息结构体（User）：
     - 钓鱼次数（fishingCount）
     - 经验值（experience）
     - 等级（level）
     - 当前渔夫NFT ID（currentFishermanNFT）
     - 当前鱼竿NFT ID（currentRodNFT）
     - 已解锁的渔场（unlockedFishingSpots）
     - 当前渔场（currentFishingSpot）
     - 渔场等级（fishPoolLevel）
     - 鱼的数量（fishCount）
     - 利率（interestRate）
     - 已收集的GMC（collectedGMC）
     - 鱼饵数量（baitCount）
  2. 合约变量：
     - 管理员角色（DEFAULT_ADMIN_ROLE）
     - 玩家映射（users）
     - GMC代币合约地址（gmcToken）
     - 等级上限（levelUpLimit）
     - 经验配置（experienceConfig）
     - 鱼饵购买上限（baitPurchaseLimit）
     - 钓鱼次数上限（fishingCountLimit）
  
- 合约函数

  1. 构造函数

     - 函数概要

     | 函数名称   | 构造函数 |
     | ---------- | -------- |
     | 函数英文名 | constructor |
     | 操作权限   | 部署者   |

     - 输入参数

     | 参数名称 | 参数英文名 | 参数描述   | 参数类型 |
     | -------- | ---------- | ---------- | -------- |
     | GMC代币地址 | _gmcToken | GMC代币合约地址 | address  |

     - 返回值

     无

     - 函数逻辑
       1. 设置调用者为默认管理员；
       2. 设置GMC代币合约地址。

  2. 添加用户函数

     - 函数概要

     | 函数名称   | 添加用户函数 |
     | ---------- | ------------ |
     | 函数英文名 | addUser      |
     | 操作权限   | 管理员       |

     - 输入参数

     | 参数名称 | 参数英文名 | 参数描述   | 参数类型 |
     | -------- | ---------- | ---------- | -------- |
     | 用户地址 | userAddress| 新用户地址 | address  |

     - 返回值

     无

     - 函数逻辑
       1. 检查调用者是否为管理员；
       2. 检查用户是否已注册；
       3. 创建新的User结构体并初始化；
       4. 将新用户添加到users映射中；
       5. 触发PlayerAdded事件。

  3. 获取用户信息函数

     - 函数概要

     | 函数名称   | 获取用户信息函数 |
     | ---------- | ---------------- |
     | 函数英文名 | getUser          |
     | 操作权限   | 公开             |

     - 输入参数

     | 参数名称 | 参数英文名  | 参数描述 | 参数类型 |
     | -------- | ----------- | -------- | -------- |
     | 用户地址 | userAddress | 玩家地址 | address  |

     - 返回值

     | 参数名称 | 参数描述     | 参数类型 |
     | -------- | ------------ | -------- |
     | 玩家信息 | 玩家的所有信息 | User     |

     - 函数逻辑
       1. 检查玩家是否已注册；
       2. 返回玩家的完整信息结构体。

  4. 减少钓鱼次数函数

     - 函数概要

     | 函数名称   | 减少钓鱼次数函数 |
     | ---------- | ---------------- |
     | 函数英文名 | decreaseFishingCount |
     | 操作权限   | 管理员           |

     - 输入参数

     | 参数名称 | 参数英文名  | 参数描述     | 参数类型 |
     | -------- | ----------- | ------------ | -------- |
     | 用户地址 | userAddress | 玩家地址     | address  |
     | 次数     | count       | 减少的次数   | uint256  |

     - 返回值

     无

     - 函数逻辑
       1. 检查调用者是否为管理员；
       2. 检查玩家是否已注册；
       3. 检查玩家的钓鱼次数是否足够；
       4. 减少玩家的钓鱼次数；
       5. 触发FishingCountDecreased事件。

  5. 恢复钓鱼次数函数

     - 函数概要

     | 函数名称   | 恢复钓鱼次数函数 |
     | ---------- | ---------------- |
     | 函数英文名 | recoverFishingCount |
     | 操作权限   | 管理员           |

     - 输入参数

     | 参数名称 | 参数英文名  | 参数描述     | 参数类型 |
     | -------- | ----------- | ------------ | -------- |
     | 用户地址 | userAddress | 玩家地址     | address  |
     | 次数     | count       | 恢复的次数   | uint256  |

     - 返回值

     无

     - 函数逻辑
       1. 检查调用者是否为管理员；
       2. 检查玩家是否已注册；
       3. 增加玩家的钓鱼次数；
       4. 如果增加后超过钓鱼次数上限,则设置为上限值；
       5. 触发FishingCountRecovered事件。

  6. 增加经验值函数

     - 函数概要

     | 函数名称   | 增加经验值函数 |
     | ---------- | -------------- |
     | 函数英文名 | addExperience  |
     | 操作权限   | 管理员         |

     - 输入参数

     | 参数名称 | 参数英文名  | 参数描述   | 参数类型 |
     | -------- | ----------- | ---------- | -------- |
     | 用户地址 | userAddress | 玩家地址   | address  |
     | 经验值   | exp         | 增加的经验 | uint256  |

     - 返回值

     无

     - 函数逻辑
       1. 检查调用者是否为管理员；
       2. 检查玩家是否已注册；
       3. 增加玩家的经验值；
       4. 检查是否达到升级条件,如果达到则升级；
       5. 触发ExperienceAdded事件,如果升级则触发PlayerLeveledUp事件。

  7. 更换渔夫NFT函数

     - 函数概要

     | 函数名称   | 更换渔夫NFT函数 |
     | ---------- | --------------- |
     | 函数英文名 | changeFisherman |
     | 操作权限   | 管理员          |

     - 输入参数

     | 参数名称   | 参数英文名   | 参数描述       | 参数类型 |
     | ---------- | ------------ | -------------- | -------- |
     | 用户地址   | userAddress  | 玩家地址       | address  |
     | 渔夫NFT ID | fishermanId  | 新的渔夫NFT ID | uint256  |

     - 返回值

     无

     - 函数逻辑
       1. 检查调用者是否为管理员；
       2. 检查玩家是否已注册；
       3. 更新玩家的当前渔夫NFT ID；
       4. 触发FishermanChanged事件。

  8. 更换鱼竿NFT函数

     - 函数概要

     | 函数名称   | 更换鱼竿NFT函数 |
     | ---------- | --------------- |
     | 函数英文名 | changeRod       |
     | 操作权限   | 管理员          |

     - 输入参数

     | 参数名称   | 参数英文名 | 参数描述       | 参数类型 |
     | ---------- | ---------- | -------------- | -------- |
     | 鱼竿NFT ID | rodId      | 新的鱼竿NFT ID | uint256  |
     | 用户地址   | userAddress| 玩家地址       | address  |

     - 返回值

     无

     - 函数逻辑
       1. 检查调用者是否为管理员；
       2. 检查玩家是否已注册；
       3. 更新玩家的当前鱼竿NFT ID；
       4. 触发RodChanged事件。

  9. 切换渔场函数

     - 函数概要

     | 函数名称   | 切换钓鱼地点函数 |
     | ---------- | ---------------- |
     | 函数英文名 | switchFishingSpot |
     | 操作权限   | 管理员           |
     | 函数名称   | 设置GMC代币合约地址函数 |
     | ---------- | ----------------------- |
     | 函数英文名 | setGMCToken             |
     | 操作权限   | 管理员                  |

     - 输入参数

     | 参数名称 | 参数英文名 | 参数描述         | 参数类型 |
     | -------- | ---------- | ---------------- | -------- |
     | 合约地址 | _gmcToken  | GMC代币合约地址  | address  |

     - 返回值

     无

     - 函数逻辑
       1. 检查调用者是否为管理员；
       2. 更新GMC代币合约地址；
       3. 触发GMCTokenSet事件。